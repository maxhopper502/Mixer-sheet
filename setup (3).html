
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mixer Setup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="setup">

<div class="header">Mixer Job Setup</div>


<div style="padding: 12px;">
  <input type="file" id="importFile" />
  <button onclick="importJob()">üìÇ Import Job</button>
</div>

<div class="job-inputs">
  <input type="text" id="client" placeholder="Client Name" />
  <input type="text" id="crop" placeholder="Crop Type" />
  <input type="text" id="pilot" placeholder="Pilot Name" />
  <input type="text" id="aircraft" placeholder="Aircraft ID" />
  <input type="number" id="hectares" placeholder="Total Hectares" />
  <input type="number" id="volPerHa" placeholder="Volume per Hectare (L)" />
  <input type="number" id="loads" placeholder="Number of Loads" />
</div>

<hr/>

<h3>Add Product</h3>
<div class="product-inputs">
  <input type="text" id="productName" placeholder="Product Name" />
  <input type="number" id="rate" step="0.001" placeholder="Rate per Ha" />
  <select id="unit">
    <option value="L">Litres</option>
    <option value="kg">Kilograms</option>
  </select>
  <div id="containerList"></div>
  <div style="margin-top:8px;">
    <input type="number" id="containerSize" placeholder="Container Size" />
    <input type="number" id="containerCount" placeholder="How Many?" />
    <button onclick="addContainer()">‚ûï Add Container</button>
  </div>
  <button onclick="addProduct()">üß™ Add Product</button>
</div>

<div id="productList"></div>

<div style="padding: 12px;">
  <button onclick="startJob()">‚ñ∂Ô∏è Start Mixing</button>
</div>

<script>
let products = [];
let currentContainers = [];

function addContainer() {
  const size = parseFloat(document.getElementById("containerSize").value);
  const count = parseInt(document.getElementById("containerCount").value);
  if (!size || !count || count <= 0) return;
  for (let i = 0; i < count; i++) {
    currentContainers.push(size);
  }
  updateContainerList();
  document.getElementById("containerSize").value = "";
  document.getElementById("containerCount").value = "";
}

function updateContainerList() {
  const list = document.getElementById("containerList");
  if (currentContainers.length === 0) {
    list.innerHTML = "<p>No containers added yet.</p>";
    return;
  }
  const summary = currentContainers.reduce((acc, size) => {
    acc[size] = (acc[size] || 0) + 1;
    return acc;
  }, {});
  list.innerHTML = "<p>Containers: " + Object.entries(summary)
    .map(([size, count]) => `${count} √ó ${size}`).join(", ") + "</p>";
}

function addProduct() {
  const name = document.getElementById("productName").value.trim();
  const rate = parseFloat(document.getElementById("rate").value);
  const unit = document.getElementById("unit").value;
  if (!name || !rate || currentContainers.length === 0) return;

  products.push({
    name,
    rate,
    unit,
    containers: [...currentContainers]
  });

  const div = document.createElement("div");
  div.className = "product-tile";
  
    const jobArea = parseFloat(document.getElementById("hectares").value);
    const required = (rate * jobArea).toFixed(2);
    const supplied = currentContainers.reduce((a,b)=>a+b,0).toFixed(2);
    const sufficient = supplied >= required;
    const status = sufficient ? "‚úÖ" : "‚ùå";

    div.innerHTML = `
      <p><strong>${name}</strong> ‚Äì ${rate} ${unit}/ha</p>
      <p>${currentContainers.length} containers added</p>
      <p>Required: ${required} ${unit}, Supplied: ${supplied} ${unit} <strong>${status}</strong></p>
    `;
    
  document.getElementById("productList").appendChild(div);

  document.getElementById("productName").value = "";
  document.getElementById("rate").value = "";
  currentContainers = [];
  updateContainerList();
}

function startJob() {
  const job = {
    client: document.getElementById("client").value,
    crop: document.getElementById("crop").value,
    pilot: document.getElementById("pilot").value,
    aircraft: document.getElementById("aircraft").value,
    hectares: parseFloat(document.getElementById("hectares").value),
    volPerHa: parseFloat(document.getElementById("volPerHa").value),
    loads: parseInt(document.getElementById("loads").value)
  };

  if (!job.client || !job.hectares || !job.volPerHa || !job.loads || products.length === 0) {
    alert("Please complete all job and product details.");
    return;
  }

  localStorage.setItem("mixerJob", JSON.stringify(job));
  localStorage.setItem("mixerProducts", JSON.stringify(products));
  window.location.href = "job.html";
}

function importJob() {
  const file = document.getElementById("importFile").files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (data.client && data.hectares && data.volPerHa && data.loads && data.products) {
        localStorage.setItem("mixerJob", JSON.stringify({
          client: data.client,
          crop: data.crop || "",
          pilot: data.pilot || "",
          aircraft: data.aircraft || "",
          hectares: data.hectares,
          volPerHa: data.volPerHa,
          loads: data.loads
        }));
        localStorage.setItem("mixerProducts", JSON.stringify(data.products));
        window.location.href = "job.html";
      } else {
        alert("Invalid job file.");
      }
    } catch (err) {
      alert("Error reading file.");
    }
  };
  reader.readAsText(file);
}

</script>

</body>
</html>
