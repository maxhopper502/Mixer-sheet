<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mixer Setup</title>
  <link rel="stylesheet" href="styles.css" />
<style>
  body.setup .header {
    height: 60px !important;
    padding: 10px 15px !important;
    font-size: 1.4rem !important;
  }
</style>
</head>
<body>
  <div class="header"><h2>üß™ Mixer Setup</h2></div>

  <!-- ‚úÖ Import Job picker -->
  <label style="margin:10px; display:block; margin-top:160px;">
    üì• Import Job:
    <input type="file" id="importFile" accept=".json" />
  </label>

  <form id="job-form" class="job-inputs">
    <input type="text" name="client" placeholder="Client" required />
    <input type="text" name="crop" placeholder="Crop Type" required />
    <input type="number" name="hectares" placeholder="Total Ha" required />
    <input type="number" name="loads" placeholder="Number of Loads" required />
    <input type="number" name="volPerHa" placeholder="Water Vol/Ha" required />
    <input type="text" name="pilot" placeholder="Pilot" required />
    <input type="text" name="aircraft" placeholder="Aircraft (e.g. ODV)" maxlength="3" required />
  </form>

  <form id="product-form" class="product-inputs">
    <input type="text" name="name" placeholder="Product Name" required />
    <input type="number" step="0.001" name="rate" placeholder="Rate" required />
    <select name="unit">
      <option value="L">L</option>
      <option value="kg">kg</option>
    </select>
    <input type="number" name="container" placeholder="Container Size" required />
    <input type="number" name="count" placeholder="# Containers" required />
    <button type="submit">Add Product</button>
  </form>

  <div id="product-list" class="product-inputs"></div>
  <button onclick="startJob()">‚û°Ô∏è Start Mixing</button>

  <script src="setup_import.js"></script>
  <script>
    let products = [];

    document.getElementById("product-form").onsubmit = e => {
      e.preventDefault();
      const data = new FormData(e.target);
      products.push({
        name: data.get("name"),
        rate: parseFloat(data.get("rate")),
        unit: data.get("unit"),
        containers: Array(parseInt(data.get("count"))).fill(parseFloat(data.get("container")))
      });
      localStorage.setItem("mixerProducts", JSON.stringify(products));
      e.target.reset();
      updateList();
    };

    function updateList() {
      const ha = parseFloat(new FormData(document.getElementById("job-form")).get("hectares") || 0);
      const list = document.getElementById("product-list");
      list.innerHTML = products.map(p => {
        const required = (p.rate * ha).toFixed(3);
        const available = p.containers.reduce((a,b)=>a+b,0).toFixed(3);
        const ok = available >= required;
        return `<p><strong>${p.name}</strong> ${p.rate.toFixed(3)} ${p.unit}/ha<br>
        Total: ${available} ${p.unit}, Required: ${required} ${p.unit}<br>
        ${ok ? "‚úÖ OK" : "‚ö†Ô∏è Not enough!"}</p>`;
      }).join("");
    }

    function startJob() {
      const f = new FormData(document.getElementById("job-form"));
      const job = {
        client: f.get("client"),
        crop: f.get("crop"),
        hectares: parseFloat(f.get("hectares")),
        loads: parseInt(f.get("loads")),
        volPerHa: parseFloat(f.get("volPerHa")),
        pilot: f.get("pilot"),
        aircraft: f.get("aircraft").trim().toUpperCase()
      };
      localStorage.setItem("mixerJob", JSON.stringify(job));
      localStorage.setItem("mixerProducts", JSON.stringify(products));
      window.location.href = "job.html";
    }
  </script>
</body>
</html>
